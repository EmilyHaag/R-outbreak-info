---
title: "outbreak.info Location Tracker"
# author: "Laura Hughes"
date: "10/8/2021"
output: html_document
---
# Accessing the data in outbreak.info's Location Tracker
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
outbreak.info's Location Tracker allows you to explore what lineages are 
currently circulating within a particular country, state/province, or U.S. county.
These reports also allow you to compare the prevalence of variants within that 
location, including Variants of Concern. Here, we'll show you how to pull the 
data from these reports and recreate the 
visualizations on the [United States Variant Report](https://outbreak.info/location-reports?loc=USA).

## Before we start...
Import the packages we'll use and provide our GISAID credentials to access the data.
If you don't have a GISAID account, you can [register](https://www.gisaid.org/registration/register/) 
for one on their website. It may take a day or two for the account to become active.
```{r pkgs, message = FALSE, results='hide'}
# Package imports
library(dplyr)
library(knitr)
library(outbreakinfo)
```

```{r auth, message = FALSE, results='hide', eval=FALSE}
# Authenticate yourself using your GISAID credentials.
authenticateUser()
```


## What lineages are circulating within the location?
To be able to discover which lineages are currently circulating around the U.S.,
let's grab the prevalence of all the lineages in the U.S. over the past 60 days.
```{r all_lineages_data, results='hide'}
usa_60d = getAllLineagesByLocation(location = "United States", other_threshold = 0.03, nday_threshold = 5, ndays = 60)
```

``` {r all_lineages_exploration1}
# This ends up being a large data frame. Let's take a look at what's inside:
usa_60d %>% glimpse()
```

You can get explanations of each of the variables by looking at the data dictionary (`outbreakinfo::genomicsDataDictionary()`). Let's look at how prevalent each of the different Pango lineages are in the U.S.:
``` {r all_lineages_exploration2}

usa_60d %>% 
  filter(lineage != "other") %>% 
  group_by(lineage) %>%
  summarise(min_prevalence = min(prevalence_rolling),
            max_prevalence = max(prevalence_rolling)) %>% 
  arrange(desc(max_prevalence)) %>% 
  kable()
```

That gives an idea of what the range of prevalences for the lineages are, but not how they have changed over time. It's easier to see this temporal behavior with a streamgraph 
which plots the relative prevalence of all the lineages over time. `plotAllLineagesByLocation` replicates these plots on outbreak.info:
```{r all_lineages_streamgraph}
plotAllLineagesByLocation("United States", other_threshold = 0.03, nday_threshold = 5, ndays = 60)
```

One thing that pops out is that there's a big group of lineages which are grouped into an "other" 
category. As of October 2021, there are over 800 separate Pango lineages which have been found in the U.S. --
way too many to plot . The parameters in `getAllLineagesByLocation` and `plotAllLineagesByLocation` group
the smaller lineages into this "other" category. Let's break down how these parameters work:

- `other_threshold` is the minimum prevalence threshold for the lineage not to be grouped into "other"
- `nday_threshold` is the number of days which that threshold must be met not to be grouped into "other"
- `ndays` is the window before the current date where to look to group lineages into "other"

... so for the example we ran before, we grouped all lineages which did not have a prevalence of at least 3% 
(`other_threshold = 0.03`) in at least 5 days (`nday_threshold = 5`) over the last 60 days (`ndays = 60`). If we want to look at more historic data, we can adjust these parameters. Let's change the window to the last year (`ndays = 365`) and find all lineages which had a prevalence of at least 5% (`other_threshold = 0.05`) in 5 days (`nday_threshold = 5`) in that year. We can also make sure certain lineages, like A.1 which was circulating early on in the pandemic, are not grouped into the "other" category by specifying `other_exclude = "a.1"`.

It's easy then to see the trends over the last year -- the North American lineages B.1 and B.1.2 appearing in 2020, the emergence of the California variants (B.1.427/B.1.429/Epsilon) and the New York variant (B.1.526/Iota) in early 2021, the rise of B.1.1.7/Alpha in the Spring of 2021, and Delta (B.1.617.2 + AY-lineages) outcompeting all lineages in summer 2021:
```{r all_lineages_streamgraph_overload}
plotAllLineagesByLocation("United States", other_threshold = 0.05, nday_threshold = 5, ndays = 365, other_exclude = "a.1")
```

One essential thing to note is that while these streamgraphs are great for looking at the breakdown
of lineages within a location over time, they're **rubbish at showing the uncertainty associated with these
estimates**. In particular, the estimates of how much lineage is in a location recently tends to be more 
unreliable, just because not as many samples have been sequenced lately. We'll plot that in the next section.
There are also other [sources of bias](https://outbreak.info/situation-reports/caveats) that are harder to estimate, but you should bear in mind when you're looking at any prevalence plots of variants.

## Comparing the prevalence of specific lineages within a location
To get a better idea of how uncertain the estimates of variant prevalence are, and also to look at the prevalence of variants that aren't high in prevalence at the moment, we can calculate the prevalence of variants over time with a 95% confidence interval. To view how these data change, we can also use the plotting function `plot` to replicate the visualization on outbreak.info. Let's look at the growth and decline of Alpha / B.1.1.7, Episilon / B.1.427 / B.1.429, Iota / B.1.526, and how Delta/B.1.617.2 overtakes them in the Spring of 2021:
```{r variant_overlay}
# The WHO lineages are a base Pango lineage with all the sublineages of the main lineage.
# Using `lookupSublineages`, we can lookup all the sublineages associated with the WHO designated sequence, according to the most recent classifications from the Pango team.
alpha_lineages = lookupSublineages("Alpha", returnQueryString = TRUE)
epsilon_lineages = lookupSublineages("Epsilon", returnQueryString = TRUE)
iota_lineages = lookupSublineages("Iota", returnQueryString = TRUE)
delta_lineages = lookupSublineages("Delta", returnQueryString = TRUE)
# create a label dictionary to rename the lineages by their WHO name:
who_labels = c("Alpha", "Epsilon", "Iota", "Delta")
names(who_labels) = c(alpha_lineages, epsilon_lineages, iota_lineages, delta_lineages)

who_prevalence = getPrevalenceByLocation(pangolin_lineage = c(alpha_lineages, epsilon_lineages, iota_lineages, delta_lineages), location = "United States")
plotPrevalenceByLocation(pangolin_lineage = c(alpha_lineages, epsilon_lineages, iota_lineages, delta_lineages), labelDictionary = who_labels, location = "United States")
```


## What mutations are contained within the lineages that are circulating within the U.S.?

## How prevalent are Variants of Concern within the U.S.?

## Where are the Variants of Concern most prevalent within the U.S.?
